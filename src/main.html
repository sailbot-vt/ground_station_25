<!DOCTYPE html>
<html>

<head>
    <title>Sailboat Tracker</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js"></script>
    <script src="https://rawgit.com/bbecquet/Leaflet.RotatedMarker/master/leaflet.rotatedMarker.js"></script>
    <script src="qwebchannel.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css" />
    <style>
        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
        }
    </style>
</head>

<body>

    <div id="map"></div>
    <script>
        class map_interface {
            static map_options = {
                center: [36.983731367697374, -76.29555376681454],
                zoom: 13
            }
            static boat_icon = L.icon({
                iconUrl: "https://github.com/sailbot-vt/ground_station_25/blob/testing/assets/boat.png?raw=true",
                iconSize: [50, 50],
                iconAnchor: [25, 25]
            })
            static wind_icon = L.icon({
                iconUrl: "https://github.com/sailbot-vt/ground_station_25/blob/testing/assets/arrow.png?raw=true",
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            })

            constructor() {
                this.boat = {
                    heading: 0,
                    location: [36.983731367697374, -76.29555376681454]
                }
                this.map = L.map("map", map_interface.map_options)
                this.waypoints = []
                
                L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
                    maxZoom: 18
                }).addTo(this.map)

                // Click event to add waypoint
                this.map.on("click", e => {
                    this.add_waypoint(e.latlng.lat, e.latlng.lng);
                })

                // Right-click event to remove waypoint
                this.map.on("contextmenu", e => {
                    let closest_index = -1
                    let closest_distance = Infinity
                    this.waypoints.forEach((waypoint, index) => {
                        const distance = Math.sqrt(
                            (waypoint[0] - e.latlng.lat) ** 2 +
                            (waypoint[1] - e.latlng.lng) ** 2
                        )
                        if (distance < closest_distance) {
                            closest_index = index
                            closest_distance = distance
                        }
                    })
                    if (closest_index !== -1) {
                        this.remove_waypoint(closest_index);
                    }
                })

                this.boat_marker = L.marker(this.boat.location, {
                    icon: map_interface.boat_icon,
                    rotationAngle: this.boat.heading,
                    rotationOrigin: "center"
                }).addTo(this.map)
            }

            // Send waypoints to PyQt
            send_waypoints_to_pyqt() {
                console.log("Sending waypoints to PyQt")
                if (window.pyqtInterface) {
                    console.log("Sent waypoints to PyQt")
                    window.pyqtInterface.update_waypoints(this.waypoints);
                }
            }

            add_waypoint(lat, lon) {
                this.waypoints.push([lat, lon]);
                L.marker([lat, lon]).addTo(this.map);
                this.send_waypoints_to_pyqt(); // Send the updated waypoints to PyQt
            }

            remove_waypoint(index) {
                this.waypoints.splice(index, 1);
                this.map.eachLayer(layer => {
                    if (layer instanceof L.Marker && !layer._icon.src.includes("boat.png")) {
                        this.map.removeLayer(layer);
                    }
                });
                this.waypoints.forEach(waypoint => {
                    L.marker(waypoint).addTo(this.map);
                });
                this.send_waypoints_to_pyqt(); // Send the updated waypoints to PyQt
            }

            focus_map_on_waypoint(lat, lon) {
                this.map.setView([lat, lon], 15);
            }
        }
        map = new map_interface();
    </script>
</body>

</html>
