<!DOCTYPE html>
<html>

<head>
    <title>Sailboat Tracker</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css" />
    <style>
        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
        }
    </style>
</head>

<body>
    <script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js"></script>
    <script src="https://rawgit.com/bbecquet/Leaflet.RotatedMarker/master/leaflet.rotatedMarker.js"></script>

    <div id="map"></div>
    <script>
        class map_interface {
            static map_options = {
                center: [36.983731367697374, -76.29555376681454],
                zoom: 13
            }
            static boat_icon = L.icon({
                iconUrl: "https://github.com/sailbot-vt/ground_station_25/blob/testing/assets/boat.png?raw=true",
                iconSize: [50, 50],
                iconAnchor: [25, 25]
            })
            static wind_icon = L.icon({
                iconUrl: "https://github.com/sailbot-vt/ground_station_25/blob/testing/assets/arrow.png?raw=true",
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            })

            constructor() {
                this.boat = {
                    heading: 0,
                    location: [36.983731367697374, -76.29555376681454]
                }
                this.map = L.map("map", map_interface.map_options)
                this.waypoints = []

                L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
                    maxZoom: 18
                }).addTo(this.map)

                this.boat_marker = L.marker(this.boat.location, {
                    icon: map_interface.boat_icon,
                    rotationAngle: this.boat.heading,
                    rotationOrigin: "center"
                })
                    .addTo(this.map)
                    .bindPopup("Sailboat Location:\n ${}")
                this.map.on("click", e => {
                    this.add_waypoint(e.latlng.lat, e.latlng.lng)
                })
            }

            async send_waypoint_to_server() {
                try {
                    const response = await fetch("http://localhost:3000/waypoints", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        // only send new waypoints
                        body: JSON.stringify({
                            curr_waypoint: this.waypoints[this.waypoints.length - 1]
                        }),
                    });

                    if (response.ok) {
                        console.log("Waypoint successfully sent to server");
                    } else {
                        console.error("Failed to send waypoint to server");
                    }
                } catch (error) {
                    console.error("Error sending waypoint:", error);
                }
            }

            add_waypoint(lat, lon) {
                this.waypoints.push([lat, lon])
                L.marker([lat, lon]).addTo(this.map)
                this.send_waypoints_to_server();
            }

            remove_waypoint(index) {
                this.waypoints.splice(index, 1)
                this.map.eachLayer(layer => {
                    if (layer instanceof L.Marker) {
                        this.map.removeLayer(layer)
                    }
                })
                this.waypoints.forEach(waypoint => {
                    L.marker(waypoint).addTo(this.map)
                })
                this.send_waypoints_to_server();
            }

            clear_waypoints() {
                this.waypoints = []
                this.map.eachLayer(layer => {
                    if (layer instanceof L.Marker) {
                        this.map.removeLayer(layer)
                    }
                })
                this.send_waypoints_to_server();
            }

            update_boat(lat, lon, heading) {
                this.boat.location = [lat, lon]
                this.boat.heading = heading
                this.boat_marker
                    .setLatLng(this.boat.location)
                    .bindPopup("Sailboat Location: " + lat.toFixed(5) + ", " + lon.toFixed(5))
            }

            add_wind_arrow(lat, lon, wind_dir, wind_speed) {
                // Skip adding if too far from the boat
                if (
                    Math.abs(lat - this.boat.location[0]) > 0.5 ||
                    Math.abs(lon - this.boat.location[1]) > 0.5
                ) {
                    return
                }

                var windArrowMarker = L.marker([lat, lon], {
                    icon: map_interface.wind_icon,
                    rotationAngle: wind_dir,
                    rotationOrigin: "center"
                }).addTo(this.map)

                windArrowMarker.bindPopup(`Wind: ${wind_dir}Â°, ${wind_speed} m/s`)
            }

            clear_wind_arrows() {
                this.map.eachLayer(layer => {
                    if (layer instanceof L.Marker) {
                        const popup = layer.getPopup()
                        const content = popup?.getContent()
                        if (
                            content &&
                            typeof content === "string" &&
                            content.includes("Wind:")
                        ) {
                            this.map.removeLayer(layer)
                        }
                    }
                })
            }
        }
        map = new map_interface();
    </script>
</body>

</html>
